# name: Deploy static to cloudflare-prod

# on:
#   push:
#     branches: [ main, master ]

# permissions:
#   contents: write
#   pull-requests: write

# concurrency:
#   group: deploy-cloudflare-prod
#   cancel-in-progress: true

# jobs:
#   build-and-submit:
#     runs-on: ubuntu-latest
#     env:
#       GH_TOKEN: ${{ github.token }}  # expose token to gh CLI

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Use Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: Install dependencies
#         run: npm ci

#       - name: Build static site
#         run: npm run build

#       - name: Publish dist to release branch
#         run: |
#           set -e
#           git config user.name "${{ github.actor }}"
#           git config user.email "${{ github.actor }}@users.noreply.github.com"

#           # Ensure base branch exists
#           git fetch origin cloudflare-prod || true

#           # Create clean worktree from cloudflare-prod as base
#           git worktree add -f ../release-worktree cloudflare-prod

#           # Switch worktree to new release branch off cloudflare-prod
#           pushd ../release-worktree
#           git checkout -B release
#           popd

#           # Clean worktree but keep .git
#           find ../release-worktree -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

#           # Copy build output
#           rsync -a --delete --exclude='.git' dist/ ../release-worktree/

#           # Commit & push
#           pushd ../release-worktree
#           git add -f -A
#           git commit -m "Deploy static content from ${GITHUB_SHA}" || echo "No changes"
#           git push -u origin release --force
#           popd

#       - name: Create PR with PAT
#         env:
#           GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
#           BASE_BRANCH: cloudflare-prod
#           HEAD_BRANCH: release
#           TITLE: "Deploy static site"
#           BODY: "Automated deploy"
#         run: |
#           chmod +x .github/scripts/create_pr.sh
#           .github/scripts/create_pr.sh
