name: Deploy static to cloudflare-prod

on:
  push:
    branches: [ main, master ]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: deploy-cloudflare-prod
  cancel-in-progress: true

jobs:
  build-and-submit:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}  # expose token to gh CLI

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build static site
        run: npm run build

      - name: Publish dist to release branch
        run: |
          set -e
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          # Create or reset release worktree
          git fetch origin release || true
          git worktree add -f ../release-worktree release || git checkout -B release

          # Clean worktree but keep .git metadata
          find ../release-worktree -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy built assets into worktree (do not touch .git)
          rsync -a --delete --exclude='.git' dist/ ../release-worktree/

          pushd ../release-worktree
          git status
          git add -f -A
          git commit -m "Deploy static content from ${GITHUB_SHA}" || echo "No changes"
          git push -u origin release --force
          popd

      - name: Create PR with PAT
        env:
          GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
          BASE_BRANCH: cloudflare-prod
          HEAD_BRANCH: release
          TITLE: "Deploy static site"
          BODY: "Automated deploy"
        run: |
          chmod +x .github/scripts/create_pr.sh
          .github/scripts/create_pr.sh
